<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa MEF 2026 – Descarga de listados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fuente Google Fonts: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body { font-family: 'Inter', sans-serif; }
    
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    
    #map { z-index: 0; height: 100vh; width: 100vw; }
    .transition-all-300 { transition: all 0.3s ease; }
    
    .leaflet-popup-content-wrapper {
        border-radius: 12px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        padding: 0;
        overflow: hidden;
    }
    .leaflet-popup-content { margin: 0; width: 280px !important; }
    .leaflet-popup-tip { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
    .leaflet-container a.leaflet-popup-close-button {
        color: #64748b;
        font-size: 24px;
        padding: 8px;
        width: 30px;
        height: 30px;
    }
  </style>
</head>

<body class="bg-gray-100 overflow-hidden relative">

  <!-- UI CONTAINER -->
  <div class="absolute top-0 left-0 h-full w-full md:w-[400px] z-[1000] pointer-events-none flex flex-col p-4">
    
    <!-- PANEL PRINCIPAL -->
    <div class="pointer-events-auto bg-white/95 backdrop-blur-md shadow-2xl rounded-2xl flex flex-col h-auto max-h-[90%] md:h-auto border border-white/20 overflow-hidden transition-all-300">
      
      <!-- HEADER -->
      <div class="bg-slate-50 p-5 border-b border-gray-100">
        <div class="flex items-center gap-2 mb-1">
          <div class="bg-blue-600 text-white p-1.5 rounded-lg">
            <i class="fa-solid fa-map-location-dot"></i>
          </div>
          <span class="text-xs font-bold text-blue-600 uppercase tracking-wider">MEF 2026</span>
        </div>
        <h1 class="text-xl font-bold text-slate-800 leading-tight">Valores Arancelarios</h1>
        <p class="text-xs text-slate-500 mt-1">Fuente: R.M. N° 514-2025-EF/15</p>
      </div>

      <!-- BUSCADOR -->
      <div class="p-4 bg-white space-y-3">
        <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider ml-1">Buscar Distrito o Ubigeo</label>
        <div class="relative group">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-blue-500 transition-colors"></i>
          </div>
          <input id="q" type="text" 
            class="block w-full pl-10 pr-10 py-3 border border-slate-200 rounded-xl leading-5 bg-slate-50 placeholder-slate-400 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition-all shadow-sm sm:text-sm" 
            placeholder="Ej: Los Olivos, Lima o 150101" />
          
          <button id="btnClear" class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer text-slate-300 hover:text-slate-500 transition-colors hidden">
            <i class="fa-solid fa-circle-xmark"></i>
          </button>
        </div>
      </div>

      <!-- LISTA DE RESULTADOS -->
      <div id="results" class="flex-1 overflow-y-auto custom-scroll p-4 pt-0 space-y-2 bg-white">
        <div class="text-center py-8 opacity-60">
            <div class="bg-slate-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                <i class="fa-regular fa-keyboard text-slate-400 text-xl"></i>
            </div>
            <p class="text-sm text-slate-500">Escribe para filtrar distritos</p>
        </div>
      </div>

      <!-- FOOTER -->
      <div class="p-4 bg-slate-50 border-t border-slate-100 text-center">
        <p class="text-[10px] text-slate-400 mb-3">Datos proporcionados por el Ministerio de Economía y Finanzas</p>
        
        <div class="border-t border-slate-200 w-1/2 mx-auto my-3"></div>
        
        <p class="text-xs font-bold text-slate-700 mb-3">Desarrollado por Lab Urban Risk</p>
        
        <div class="flex justify-center gap-5 pb-1">
          <!-- YouTube -->
          <a href="https://youtube.com/@laburbanrisk?si=COqNXDTX7TAQSqDO" target="_blank" rel="noopener" 
             class="text-slate-400 hover:text-red-600 transition-colors transform hover:scale-110 duration-200" title="YouTube">
            <i class="fa-brands fa-youtube text-xl"></i>
          </a>
          <!-- Facebook -->
          <a href="https://www.facebook.com/share/1Db3ZgmTE4/?mibextid=wwXIfr" target="_blank" rel="noopener" 
             class="text-slate-400 hover:text-blue-600 transition-colors transform hover:scale-110 duration-200" title="Facebook">
            <i class="fa-brands fa-facebook text-xl"></i>
          </a>
          <!-- Instagram -->
          <a href="https://www.instagram.com/laburbanrisk?igsh=MWNzam53enpzZng4Ng%3D%3D&utm_source=qr" target="_blank" rel="noopener" 
             class="text-slate-400 hover:text-pink-600 transition-colors transform hover:scale-110 duration-200" title="Instagram">
            <i class="fa-brands fa-instagram text-xl"></i>
          </a>
          <!-- TikTok -->
          <a href="https://www.tiktok.com/@laburbanrisk?_r=1&_t=ZN-92idJVeblZe" target="_blank" rel="noopener" 
             class="text-slate-400 hover:text-black transition-colors transform hover:scale-110 duration-200" title="TikTok">
            <i class="fa-brands fa-tiktok text-xl"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- 1. CONFIGURACIÓN DEL MAPA ---
    const map = L.map("map", { zoomControl: false }).setView([-12.0464, -77.0428], 11); // Centrado en Lima
    
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    // --- 2. ESTILOS ---
    function style(feature) {
      return {
        color: "#3b82f6",
        weight: 1.5,
        opacity: 1,
        fillColor: "#60a5fa",
        fillOpacity: 0.1
      };
    }

    function highlightFeature(e) {
      const layer = e.target;
      layer.setStyle({ weight: 3, color: '#2563eb', fillOpacity: 0.3 });
      layer.bringToFront();
    }

    function resetHighlight(e) {
      geojson.resetStyle(e.target);
    }

    // --- 3. LÓGICA DE DATOS ---
    let geojson;
    let featuresIndex = []; 
    const resultsEl = document.getElementById("results");
    const qEl = document.getElementById("q");
    const btnClear = document.getElementById("btnClear");

    // Función auxiliar para obtener el nombre del distrito de forma robusta
    function getDistrictName(props) {
        // Intenta encontrar el nombre en las propiedades más comunes
        return props.distrito || props.dist || props.NOMBDIST || props.NOMB_DIST || props.name || "Distrito Desconocido";
    }

    // Función auxiliar para quitar tildes (normalización) para búsqueda
    function normalizeText(text) {
        return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
    }

    function popupHtml(p) {
      const zipUrl = p.mef_zip_url || "";
      const distrito = getDistrictName(p);
      const ubigeo = p.ubigeo || p.UBIGEO || "---";
      
      return `
        <div class="font-sans">
            <div class="bg-slate-800 text-white p-4">
                <h3 class="font-bold text-lg leading-tight mb-1">${distrito}</h3>
                <span class="inline-block bg-slate-600 text-xs px-2 py-0.5 rounded text-slate-200">UBIGEO: ${ubigeo}</span>
            </div>
            <div class="p-4 bg-white">
                ${zipUrl ? `
                    <p class="text-sm text-slate-600 mb-3">Listado disponible para descarga.</p>
                    <a href="${zipUrl}" target="_blank" rel="noopener" 
                       class="block w-full bg-blue-600 hover:bg-blue-700 text-white text-center font-bold py-2 px-4 rounded-lg transition-colors duration-200 shadow-lg shadow-blue-500/30 flex items-center justify-center gap-2 text-sm decoration-none">
                       <i class="fa-solid fa-file-zipper"></i> Descargar ZIP
                    </a>
                ` : `
                    <div class="flex flex-col items-center justify-center py-2 text-slate-400">
                        <i class="fa-regular fa-folder-open text-2xl mb-2"></i>
                        <span class="text-xs font-medium">No hay archivo disponible</span>
                    </div>
                `}
            </div>
        </div>
      `;
    }

    function onEachFeature(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: resetHighlight,
        click: (e) => {
            map.flyToBounds(e.target.getBounds(), { padding: [50, 50], maxZoom: 13 });
            layer.bindPopup(popupHtml(feature.properties || {})).openPopup();
        }
      });

      const p = feature.properties || {};
      const rawName = getDistrictName(p);
      
      featuresIndex.push({
        feature,
        layer,
        nameDisplay: rawName, // Nombre original para mostrar
        nameSearch: normalizeText(rawName), // Nombre normalizado para buscar
        ubigeo: String(p.ubigeo || p.UBIGEO || ""),
        zipUrl: String(p.mef_zip_url || "")
      });
    }

    // --- 4. RENDERIZADO ---
    function renderResults(list) {
      if (!list.length) {
        resultsEl.innerHTML = `
            <div class="text-center py-8">
                <p class="text-sm text-slate-400">No se encontraron resultados</p>
            </div>`;
        return;
      }

      resultsEl.innerHTML = list.slice(0, 50).map(item => { 
        const hasZip = !!item.zipUrl;
        return `
          <div class="item-result group cursor-pointer p-3 rounded-xl border border-transparent hover:bg-blue-50 hover:border-blue-100 transition-all duration-200 mb-2" data-ubigeo="${item.ubigeo}">
            <div class="flex justify-between items-start">
                <div>
                    <div class="font-bold text-slate-700 group-hover:text-blue-700 text-sm mb-0.5">${item.nameDisplay}</div>
                    <div class="text-[11px] text-slate-400 font-mono">UBIGEO: ${item.ubigeo}</div>
                </div>
                ${hasZip ? 
                    `<div class="text-blue-500 bg-blue-100 p-1.5 rounded-lg text-xs group-hover:bg-blue-600 group-hover:text-white transition-colors"><i class="fa-solid fa-download"></i></div>` : 
                    `<div class="text-slate-300 p-1 text-xs"><i class="fa-solid fa-ban"></i></div>`
                }
            </div>
          </div>
        `;
      }).join("");

      document.querySelectorAll(".item-result").forEach(el => {
        el.addEventListener("click", () => {
          const ub = el.getAttribute("data-ubigeo");
          const found = featuresIndex.find(x => x.ubigeo === ub);
          if (!found) return;

          document.querySelectorAll(".item-result").forEach(i => i.classList.remove("bg-blue-100", "border-blue-200"));
          el.classList.add("bg-blue-100", "border-blue-200");

          const b = found.layer.getBounds();
          map.flyToBounds(b, { maxZoom: 13, duration: 1.5 });
          setTimeout(() => {
              found.layer.bindPopup(popupHtml(found.feature.properties || {})).openPopup();
          }, 1000);
        });
      });
    }

    // --- 5. BUSCADOR INTELIGENTE ---
    function doSearch() {
      const rawQ = (qEl.value || "").trim();
      const q = normalizeText(rawQ); // Normalizar búsqueda (quitar tildes, mayúsculas)
      
      if(rawQ.length > 0) btnClear.classList.remove('hidden');
      else btnClear.classList.add('hidden');

      if (!q) {
        resultsEl.innerHTML = `
            <div class="text-center py-8 opacity-60">
                <div class="bg-slate-100 rounded-full w-12 h-12 flex items-center justify-center mx-auto mb-3">
                    <i class="fa-regular fa-keyboard text-slate-400 text-xl"></i>
                </div>
                <p class="text-sm text-slate-500">Escribe para filtrar distritos</p>
            </div>`;
        return;
      }

      const isUbigeoQuery = /^[0-9]+$/.test(q); 
      const filtered = featuresIndex.filter(x => {
        if (isUbigeoQuery) return x.ubigeo.startsWith(q);
        return x.nameSearch.includes(q); // Buscar en nombre normalizado
      });

      renderResults(filtered);
    }

    qEl.addEventListener("input", doSearch);
    btnClear.addEventListener("click", () => {
      qEl.value = "";
      doSearch();
      qEl.focus();
    });

    // --- 6. CARGA DE DATOS ---
    fetch("distritos_mef_2026_con_zip.geojson")
      .then(r => {
          if (!r.ok) throw new Error("No se encontró archivo local");
          return r.json();
      })
      .then(data => {
        geojson = L.geoJSON(data, { style, onEachFeature }).addTo(map);
        map.fitBounds(geojson.getBounds());
      })
      .catch(err => {
        console.warn("Modo Demo Activado");
        
        // --- DATOS MOCK AMPLIADOS PARA PRUEBAS ---
        // Generamos polígonos aproximados para distritos populares de Lima
        const mockData = {
            "type": "FeatureCollection",
            "features": [
                { "type": "Feature", "properties": { "distrito": "LIMA", "ubigeo": "150101", "mef_zip_url": "#" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.045, -12.045], [-77.025, -12.045], [-77.025, -12.065], [-77.045, -12.065], [-77.045, -12.045]]] } },
                { "type": "Feature", "properties": { "distrito": "LOS OLIVOS", "ubigeo": "150117", "mef_zip_url": "#" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.080, -11.960], [-77.060, -11.960], [-77.060, -11.990], [-77.080, -11.990], [-77.080, -11.960]]] } },
                { "type": "Feature", "properties": { "distrito": "MIRAFLORES", "ubigeo": "150122", "mef_zip_url": "#" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.020, -12.110], [-77.045, -12.110], [-77.045, -12.135], [-77.020, -12.135], [-77.020, -12.110]]] } },
                { "type": "Feature", "properties": { "distrito": "SAN ISIDRO", "ubigeo": "150131", "mef_zip_url": "#" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.025, -12.085], [-77.050, -12.085], [-77.050, -12.105], [-77.025, -12.105], [-77.025, -12.085]]] } },
                { "type": "Feature", "properties": { "distrito": "BARRANCO", "ubigeo": "150104", "mef_zip_url": null }, "geometry": { "type": "Polygon", "coordinates": [[[-77.020, -12.135], [-77.030, -12.135], [-77.030, -12.155], [-77.020, -12.155], [-77.020, -12.135]]] } },
                { "type": "Feature", "properties": { "distrito": "SANTIAGO DE SURCO", "ubigeo": "150140", "mef_zip_url": "#" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.000, -12.120], [-76.970, -12.120], [-76.970, -12.160], [-77.000, -12.160], [-77.000, -12.120]]] } },
                { "type": "Feature", "properties": { "distrito": "JESUS MARIA", "ubigeo": "150113", "mef_zip_url": "#" }, "geometry": { "type": "Polygon", "coordinates": [[[-77.050, -12.070], [-77.035, -12.070], [-77.035, -12.090], [-77.050, -12.090], [-77.050, -12.070]]] } }
            ]
        };
        geojson = L.geoJSON(mockData, { style, onEachFeature }).addTo(map);
        
        const warning = document.createElement('div');
        warning.className = "absolute bottom-5 left-1/2 transform -translate-x-1/2 bg-amber-100 text-amber-800 border border-amber-200 px-4 py-2 rounded-lg text-xs font-bold shadow-lg z-[2000] flex items-center gap-2";
        warning.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Modo Demo: Mostrando datos de prueba. Carga tu .geojson real para ver todo Perú.";
        document.body.appendChild(warning);
      });

  </script>
</body>
</html>
